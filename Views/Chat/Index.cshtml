
<link href="~/css/chat_admin.css" rel="stylesheet" />


<div id="chatVue">
    <section style="background-color: #CDC4F9;">
        <div style="scroll-behavior: smooth;">

            <div class="row">
                <div class="col-md-12">

                    <div class="card" id="chat3" style="border-radius: 15px;">
                        <div class="card-body">

                            <div class="row">
                                <div class="col-md-6 col-lg-5 col-xl-4 mb-4 mb-md-0">

                                    <div class="p-3">

                                        <div class="input-group rounded mb-3">
                                            <h3 style="margin-right: 0.5em;">Danh sách chat tài khoản đã đăng ký</h3>
                                        </div>

                                        <div data-mdb-perfect-scrollbar="true" style="position: relative;">
                                            <ul id="DanhSachChart" class="list-unstyled mb-0 overflow-auto" style="height: auto;">
                                            </ul>
                                        </div>

                                        <div class="input-group rounded mb-3">
                                            <h3 style="margin-right: 0.5em;">Danh sách chat tài khoản chưa đăng ký</h3>
                                        </div>

                                        <div data-mdb-perfect-scrollbar="true" style="position: relative;">
                                            <ul id="DanhSachChartOther" class="list-unstyled mb-0 overflow-auto" style="height: auto;">
                                            </ul>
                                        </div>

                                    </div>

                                </div>

                                <div class="col-md-6 col-lg-7 col-xl-8">

                                    <div id="Chat_Message_Box" class="pt-3 pe-3 overflow-auto" data-mdb-perfect-scrollbar="true"
                                         style="position: relative; height: 400px">
                                    </div>

                                    <div id="BoxTextChat" class="bg-red text-muted d-flex justify-content-start align-items-center pe-3 pt-3 mt-2">
                                        <img src="https://bst.icons8.com/wp-content/uploads/2023/04/goprod_remove_background_and_upscale_images.gif"
                                             alt="avatar 3" style="width: 40px; height: 100%;">
                                        <input type="text" class="form-control form-control-lg" id="ValueSend"
                                               placeholder="Type message">
                                        <label class="custom-file-upload">
                                            <input type="file" id="img_send" style="width:100%" accept="image/png,image/jpeg,image/jpg" />
                                            <span>Tải lên</span>
                                        </label>
                                        <a id="btnsend" class="ms-3" href="#!"><i class="fas fa-paper-plane"></i></a>
                                    </div>

                                </div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>

        </div>
    </section>
</div>


<script src="~/lib/microsoft/signalr/dist/browser/signalr.js"></script>

<script>
    "use strict";
    //đặt cở check khi nào xong
    $('#preloader').fadeIn();

    var list_user = [];

    var flagLoadedChat = false;
    var currentUser = "";
    var prevUser = '';
    var currentAdmin = "supperadmin";

    var connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();



    connection.start().then(function () {
        connection.invoke("HistoryChatAdmin", "user112")
            .then(res => { getOtherUser() })
            .catch(function (err) {
                $('#preloader').fadeOut();
                console.log("err HistoryChatAdmin", err)
            });
    }).catch(function (err) {
        $('#preloader').fadeOut();
        return;
    });

    //lịch roomchat có design
    connection.on("ReceiveMessageHistoryToAdmin", function (admin, listuser) {
        console.log("admin", admin)
        console.log("listuser", listuser)
        let ul_dsChart = document.getElementById("DanhSachChart");
        if (history.length == 0) {
            $('#preloader').fadeOut();
            return;
        }
        // người dùng đăng nhập
        listuser.forEach(item => {
            if (currentAdmin == item.adminUser) {
                return;
            }
            let li = document.createElement("li");
            li.classList.add("p-2", "border-bottom", "bg-success", "opacity-7", "border", "rounded", `${item.adminUser}`);
            li.innerHTML = `
                            <a href="#!" class="d-flex justify-content-between" onclick="ChooseUserNameByUser('${item.adminUser}')">
                                                                <div class="d-flex flex-row">
                                                                    <div>
                                                                                <img src="${item.adminAvatar}"
                                                                             alt="avatar" class="d-flex align-self-center me-3" width="60" height="50">
                                                                        <span class="badge bg-warning badge-dot"></span>
                                                                    </div>
                                                                    <div class="pt-1">
                                                                                    <p class="fw-bold mb-0">${item.adminName}</p>
                                                                    </div>
                                                                </div>
                                                                <div class="pt-1">

                                                                    <span class="badge bg-danger rounded-pill float-end notification_Js" ></span>
                                                                </div>
                                                            </a>
                        `;
            ul_dsChart.appendChild(li);

        });
        $('#preloader').fadeOut();
    });


    connection.on("ReceiveMessageToUser", function (user, adminChat, messange) {

        let ul = document.getElementById("Chat_Message_Box");
        let li = document.createElement("p");
        li.innerHTML = `${messange}`

        ul.appendChild(li)

    })

    connection.on("ReceiveMessageToAdmin", function (user, adminChat, messange) {

        let ul = document.getElementById("Chat_Message_Box");
        let li = document.createElement("p");
        if (adminChat == currentAdmin) {
            li.style.background = "red"
        }
        li.innerHTML = `${messange}`

        ul.appendChild(li)

    })

    function ChooseUserNameByUser(userName) {
        let boxChat = document.getElementById("Chat_Message_Box");
        boxChat.innerHTML = "";
        fetch(`/Chat/historyChat?fromUser=${currentAdmin}&toUser=${userName}`)
            .then(res => res.json())
            .then(data => {
                data.forEach(item => {
                    let li = document.createElement("li")
                    li.innerHTML = item.content;
                    if (item.fromUser == currentAdmin) {
                        li.style.background = "red";
                    };

                    boxChat.appendChild(li);
                })
            })
    }


    document.getElementById("btnsend").addEventListener("click", function (event) {

        let user = 'admin1234';
        let message = document.getElementById("ValueSend").value;
        if (!(!message.trim())) {
            connection.invoke("AdminSendMessage", user, currentAdmin, message).then(data => { document.getElementById("ValueSend").value = ""; return data })
                .catch(function (err) {
                    return console.error(err.toString());
                });
        }
        event.preventDefault();
    });

    //lấy danh sách người dùng vô danh
    function getOtherUser() {
        fetch("/Chat/GetOtherUser")
            .then(res => res.json())
            .then(data => {
                let ul_dsChart = document.getElementById("DanhSachChartOther");
                if (history.length == 0) {
                    $('#preloader').fadeOut();
                    return;
                }
                // người dùng đăng nhập
                data.forEach(item => {
                    if (currentAdmin == item.adminUser) {
                        return;
                    }
                    let li = document.createElement("li");
                    li.classList.add("p-2", "border-bottom", "bg-success", "opacity-7", "border", "rounded", `${item.name}`);
                    li.innerHTML = `
                                        <a href="#!" class="d-flex justify-content-between" onclick="ChooseUserNameByOtherUser('${item.name}')">
                                                                    <div class="d-flex flex-row">
                                                                        <div class="pt-1 col-12">
                                                                                            <p class="fw-bold mb-0">${item.name}</p>
                                                                        </div>
                                                                    </div>
                                                                    <div class="pt-1">

                                                                        <span class="badge bg-danger rounded-pill float-end notification_Js" ></span>
                                                                    </div>
                                                                </a>
                            `;
                    ul_dsChart.appendChild(li);

                });
                $('#preloader').fadeOut();
            })
    }

    //lấy lịch sử người dùng khác
    ChooseUserNameByOtherUser (name){

    }

    window.addEventListener("keydown", function (event) {
        if (event.keyCode === 13) {
            event.preventDefault(); // Ngăn chặn hành vi mặc định của phím Enter

            document.getElementById("btnsend").click(); // Kích hoạt sự kiện click cho nút btnsend
        }
    });


</script>